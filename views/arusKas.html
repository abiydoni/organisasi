<div class="space-y-4 md:space-y-6">
  <div
    class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"
  >
    <div>
      <h2
        class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-1"
      >
        <i class="bx bx-book text-yellow-600 dark:text-yellow-400"></i> Arus Kas
      </h2>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Lihat transaksi keuangan organisasi
      </p>
    </div>
    <div class="flex items-center gap-3">
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-700 dark:text-gray-300">Bulan:</label>
        <select
          id="bulanFilter"
          class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 dark:bg-gray-700 dark:text-white transition-all text-sm"
          onchange="filterArusKas()"
        >
          <option value="">Semua</option>
          <option value="1">Januari</option>
          <option value="2">Februari</option>
          <option value="3">Maret</option>
          <option value="4">April</option>
          <option value="5">Mei</option>
          <option value="6">Juni</option>
          <option value="7">Juli</option>
          <option value="8">Agustus</option>
          <option value="9">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
          <option value="12">Desember</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-700 dark:text-gray-300">Tahun:</label>
        <select
          id="tahunFilter"
          class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 dark:bg-gray-700 dark:text-white transition-all text-sm"
          onchange="filterArusKas()"
        >
          <!-- Options akan diisi oleh JavaScript -->
        </select>
      </div>
    </div>
  </div>

  <!-- Statistics -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
    <div
      class="bg-white dark:bg-gray-800 rounded-xl shadow-md hover:shadow-xl transition-all duration-300 p-5 md:p-6 border-l-4 border-green-500 transform hover:-translate-y-1"
    >
      <p class="text-gray-600 dark:text-gray-400 text-xs md:text-sm">
        Total Debet
      </p>
      <p
        id="stat-debet"
        class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mt-2"
      >
        0
      </p>
    </div>
    <div
      class="bg-white dark:bg-gray-800 rounded-xl shadow-md hover:shadow-xl transition-all duration-300 p-5 md:p-6 border-l-4 border-red-500 transform hover:-translate-y-1"
    >
      <p
        class="text-gray-500 dark:text-gray-400 text-xs md:text-sm font-medium uppercase tracking-wide mb-1"
      >
        Total Kredit
      </p>
      <p
        id="stat-kredit"
        class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mt-2"
      >
        0
      </p>
    </div>
    <div
      class="bg-white dark:bg-gray-800 rounded-xl shadow-md hover:shadow-xl transition-all duration-300 p-5 md:p-6 border-l-4 border-blue-500 transform hover:-translate-y-1"
    >
      <p
        class="text-gray-500 dark:text-gray-400 text-xs md:text-sm font-medium uppercase tracking-wide mb-1"
      >
        Saldo
      </p>
      <p
        id="stat-saldo"
        class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mt-2"
      >
        0
      </p>
    </div>
  </div>

  <div
    class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden"
  >
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead
          class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-800"
        >
          <tr>
            <th
              class="px-2 md:px-3 py-1.5 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase"
            >
              No
            </th>
            <th
              class="px-2 md:px-3 py-1.5 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase"
            >
              Tanggal
            </th>
            <th
              class="px-2 md:px-3 py-1.5 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase"
            >
              Keterangan
            </th>
            <th
              class="px-2 md:px-3 py-1.5 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase"
            >
              Debet
            </th>
            <th
              class="px-2 md:px-3 py-1.5 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase"
            >
              Kredit
            </th>
            <th
              class="px-2 md:px-3 py-1.5 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase"
            >
              Saldo
            </th>
          </tr>
        </thead>
        <tbody
          id="arusKasTableBody"
          class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"
        ></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Load bukuKas and stats data
  const bukuKasAll = {{bukuKas}} || [];
  const stats = {{stats}} || {};
  let bukuKas = [...bukuKasAll]; // Copy untuk filtering

  // Fungsi untuk memperpendek teks
  function truncateText(text, maxLength = 50) {
    if (!text || text === "-") return "-";

    // Jika keterangan panjang, potong
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + "...";
  }

  // Fungsi untuk cek apakah entry otomatis dari sistem
  function isAutoEntry(item) {
    return item.kategori === "iuran" ||
           (item.keterangan && (item.keterangan.includes("Iuran ") || item.keterangan.includes("Pembatalan iuran ")));
  }

  // Fungsi untuk filter arus kas berdasarkan bulan dan tahun
  function filterArusKas() {
    const bulanFilter = document.getElementById("bulanFilter").value;
    const tahunFilter = document.getElementById("tahunFilter").value;

    bukuKas = bukuKasAll.filter((item) => {
      if (!item.tanggal) return false;

      const date = new Date(item.tanggal);
      const bulan = date.getMonth() + 1; // getMonth() returns 0-11
      const tahun = date.getFullYear();

      const matchBulan = !bulanFilter || bulan.toString() === bulanFilter;
      const matchTahun = !tahunFilter || tahun.toString() === tahunFilter;

      return matchBulan && matchTahun;
    });

    loadArusKas();
    updateStats();
  }

  // Fungsi untuk update stats berdasarkan filtered data
  function updateStats() {
    const totalDebet = bukuKas.reduce((sum, item) => sum + (parseInt(item.debet) || 0), 0);
    const totalKredit = bukuKas.reduce((sum, item) => sum + (parseInt(item.kredit) || 0), 0);

    // Untuk saldo, ambil saldo terakhir dari data yang difilter
    // Jika ada filter, saldo adalah saldo terakhir dari periode tersebut
    // Jika tidak ada filter, gunakan saldo dari stats
    let saldo = stats.saldo || 0;
    if (bukuKas.length > 0) {
      // Urutkan berdasarkan tanggal dan id untuk mendapatkan saldo terakhir
      const sorted = [...bukuKas].sort((a, b) => {
        const dateA = new Date(a.tanggal);
        const dateB = new Date(b.tanggal);
        if (dateA.getTime() === dateB.getTime()) {
          return (a.id || 0) - (b.id || 0);
        }
        return dateA.getTime() - dateB.getTime();
      });
      saldo = sorted[sorted.length - 1]?.saldo || 0;
    }

    document.getElementById("stat-debet").textContent = formatRupiah(totalDebet);
    document.getElementById("stat-kredit").textContent = formatRupiah(totalKredit);
    document.getElementById("stat-saldo").textContent = formatRupiah(saldo);
  }

  // Fungsi untuk load tahun filter options
  function loadTahunFilter() {
    const tahunFilter = document.getElementById("tahunFilter");
    const tahunSaatIni = new Date().getFullYear();
    const tahunOptions = [];

    // Ambil semua tahun unik dari data
    const tahunUnik = [...new Set(bukuKasAll.map(item => {
      if (!item.tanggal) return null;
      return new Date(item.tanggal).getFullYear();
    }).filter(t => t !== null))].sort((a, b) => b - a);

    // Jika tidak ada data, gunakan tahun saat ini dan beberapa tahun sebelumnya
    if (tahunUnik.length === 0) {
      for (let i = tahunSaatIni; i >= tahunSaatIni - 5; i--) {
        tahunOptions.push(`<option value="${i}">${i}</option>`);
      }
    } else {
      tahunOptions.push('<option value="">Semua</option>');
      tahunUnik.forEach(tahun => {
        tahunOptions.push(`<option value="${tahun}">${tahun}</option>`);
      });
    }

    tahunFilter.innerHTML = tahunOptions.join("");
  }

  function loadArusKas() {
    const tbody = document.getElementById("arusKasTableBody");
    tbody.innerHTML = bukuKas
      .map(function(item, index) {
        // Pisahkan keterangan utama dan keterangan tambahan
        let keteranganUtama = item.keterangan || "-";
        let keteranganTambahan = "";

        // Handle newline character (bisa dari JSON.stringify yang escape atau langsung)
        const keteranganRaw = item.keterangan || "";

        // Cek apakah ada newline (bisa \n atau \\n dari JSON)
        if (keteranganRaw.includes('\n') || keteranganRaw.includes('\\n')) {
          // Replace escaped newline dengan actual newline
          const normalizedKeterangan = keteranganRaw.replace(/\\n/g, '\n');
          const parts = normalizedKeterangan.split('\n');
          if (parts.length > 1) {
            keteranganUtama = parts[0].trim();
            keteranganTambahan = parts.slice(1).join('\n').trim();
          }
        } else {
          // Untuk data lama yang masih menggunakan format "Iuran bulanan - ..."
          // Coba ekstrak informasi dari format lama dan cari nama anggota
          if (keteranganRaw.includes("Iuran bulanan -") || keteranganRaw.includes("Pembatalan iuran -")) {
            // Format lama: "Iuran bulanan - Iuran Januari 2025 - Kas (Rp 75.000)"
            // Atau: "Pembatalan iuran - Iuran Januari 2025 - Kas (Rp 75.000)"
            const parts = keteranganRaw.split(" - ");
            if (parts.length >= 2) {
              // Coba ekstrak nama bulan dan nama anggota dari format lama jika memungkinkan
              // Tapi untuk data lama, kita tetap tampilkan sebagai keterangan tambahan
              keteranganUtama = parts[0].trim();
              // Gabungkan sisa sebagai keterangan tambahan
              keteranganTambahan = parts.slice(1).join(" - ").trim();
            }
          } else if (keteranganRaw.startsWith("Iuran ") && keteranganRaw.includes(" - ")) {
            // Format baru: "Iuran Januari - Ciara" atau "Pembatalan iuran Januari - Ciara"
            // Sudah benar, tidak perlu dipisah lagi
            keteranganUtama = keteranganRaw;
          }
        }

        const shortKeterangan = truncateText(keteranganUtama);
        const isAuto = isAutoEntry(item);

        return `
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 ${isAuto ? 'bg-blue-50/30 dark:bg-blue-900/20' : ''}">
              <td class="px-2 md:px-3 py-1.5 whitespace-nowrap text-xs text-gray-800 dark:text-gray-200">${
                index + 1
              }</td>
              <td class="px-2 md:px-3 py-1.5 whitespace-nowrap text-xs text-gray-800 dark:text-gray-200">${formatDate(
                item.tanggal
              )}</td>
              <td class="px-2 md:px-3 py-1.5 text-xs text-gray-800 dark:text-gray-200">
                <div class="flex flex-col gap-0.5">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span title="${item.keterangan || "-"}">${shortKeterangan}</span>
                    ${isAuto ? '<span class="px-1 py-0.5 text-[6px] font-semibold rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 whitespace-nowrap" title="Otomatis dari sistem">AUTO</span>' : ''}
                  </div>
                  ${keteranganTambahan ? `<span class="text-[9px] text-gray-500 dark:text-gray-400 italic" title="${keteranganTambahan}">${truncateText(keteranganTambahan, 40)}</span>` : ''}
                </div>
              </td>
              <td class="px-2 md:px-3 py-1.5 whitespace-nowrap text-xs font-semibold text-green-600 dark:text-green-400 text-right">
                  ${item.debet > 0 ? formatNumber(item.debet) : "-"}
              </td>
              <td class="px-2 md:px-3 py-1.5 whitespace-nowrap text-xs font-semibold text-red-600 dark:text-red-400 text-right">
                  ${item.kredit > 0 ? formatNumber(item.kredit) : "-"}
              </td>
              <td class="px-2 md:px-3 py-1.5 whitespace-nowrap text-xs font-bold text-blue-600 dark:text-blue-400 text-right">
                  ${formatNumber(item.saldo || 0)}
              </td>
          </tr>
      `;
      })
      .join("");

    // Update stats
    updateStats();
  }

  function formatNumber(num) {
    return new Intl.NumberFormat("id-ID").format(num || 0);
  }

  function formatRupiah(angka) {
    return formatNumber(angka);
  }

  function formatDate(dateStr) {
    if (!dateStr) return "-";
    const date = new Date(dateStr);
    return date.toLocaleDateString("id-ID");
  }

  // Initialize
  loadTahunFilter();
  loadArusKas();
</script>
