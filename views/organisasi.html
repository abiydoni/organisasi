<div class="space-y-4 md:space-y-6">
  <div
    class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-5 md:p-8"
  >
    <div class="mb-6">
      <h2
        class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-2"
      >
        <i class="bx bx-building text-blue-600 dark:text-blue-400"></i> Data
        Organisasi
      </h2>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Kelola informasi organisasi Anda
      </p>
    </div>

    <form id="organisasiForm" class="space-y-3 md:space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Nama Organisasi *</label
          >
          <input
            type="text"
            name="nama"
            id="nama"
            required
            class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-all"
          />
        </div>

        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Alamat</label
          >
          <input
            type="text"
            name="alamat"
            id="alamat"
            class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-all"
          />
        </div>

        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Telepon</label
          >
          <input
            type="text"
            name="telepon"
            id="telepon"
            class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-all"
          />
        </div>

        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Email</label
          >
          <input
            type="email"
            name="email"
            id="email"
            class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-all"
          />
        </div>

        <!-- Logo di kolom kiri (separo) -->
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Logo Organisasi</label
          >

          <!-- Upload Area -->
          <div
            id="logoUploadArea"
            class="relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 md:p-6 text-center hover:border-blue-500 dark:hover:border-blue-400 transition-all duration-200 cursor-pointer bg-gray-50 dark:bg-gray-700/50"
          >
            <input
              type="file"
              name="logoFile"
              id="logoFile"
              accept="image/*"
              class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
            />
            <div id="logoUploadContent" class="space-y-2">
              <div class="flex justify-center">
                <i
                  class="bx bx-cloud-upload text-3xl md:text-4xl text-gray-400 dark:text-gray-500"
                ></i>
              </div>
              <div>
                <p
                  class="text-xs md:text-sm font-medium text-gray-700 dark:text-gray-300"
                >
                  Klik untuk upload
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  PNG, JPG, GIF max 2MB
                </p>
              </div>
            </div>

            <!-- Preview Area -->
            <div id="logoPreview" class="hidden">
              <div class="flex justify-center">
                <img
                  id="logoPreviewImg"
                  src=""
                  alt="Logo Preview"
                  class="rounded object-contain"
                  style="
                    width: 64px;
                    height: 64px;
                    max-width: 64px;
                    max-height: 64px;
                  "
                />
              </div>
              <p
                class="text-xs text-gray-500 dark:text-gray-400 mt-2"
                id="logoFileName"
              ></p>
            </div>
          </div>

          <!-- Hidden input for existing logo URL -->
          <input type="hidden" name="logo" id="logo" />

          <!-- Progress Bar -->
          <div id="logoProgress" class="hidden mt-3">
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div
                id="logoProgressBar"
                class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                style="width: 0%"
              ></div>
            </div>
            <p
              class="text-xs text-gray-600 dark:text-gray-400 mt-1 text-center"
            >
              <span id="logoProgressText">0%</span> - Uploading...
            </p>
          </div>
        </div>

        <!-- Website dan Deskripsi di kolom kanan (separo) -->
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Website</label
          >
          <input
            type="text"
            name="website"
            id="website"
            class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-all"
            placeholder="https://example.com"
          />

          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 mt-3"
            >Deskripsi</label
          >
          <textarea
            name="deskripsi"
            id="deskripsi"
            rows="4"
            class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-all"
            placeholder="Deskripsi organisasi..."
          ></textarea>
        </div>
      </div>

      <div class="flex justify-end gap-3">
        <button
          type="submit"
          class="w-full sm:w-auto px-6 md:px-8 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg transition-all duration-200 text-sm md:text-base font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center gap-2 justify-center"
        >
          <i class="bx bx-save"></i> <span>Simpan</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // Function untuk menampilkan preview logo
  function showLogoPreview(imageSrc, fileName) {
    const logoUploadContent = document.getElementById("logoUploadContent");
    const logoPreview = document.getElementById("logoPreview");
    const logoPreviewImg = document.getElementById("logoPreviewImg");
    const logoFileName = document.getElementById("logoFileName");

    if (logoUploadContent) logoUploadContent.classList.add("hidden");
    if (logoPreview) logoPreview.classList.remove("hidden");
    if (logoPreviewImg) logoPreviewImg.src = imageSrc;
    if (logoFileName) logoFileName.textContent = fileName;
  }

  // Load existing data - wait for DOM to be ready
  document.addEventListener("DOMContentLoaded", function () {
    // organisasi sudah dideklarasikan di layout.html
    if (typeof organisasi !== "undefined" && organisasi && organisasi.nama) {
      if (document.getElementById("nama")) {
        document.getElementById("nama").value = organisasi.nama || "";
      }
      if (document.getElementById("alamat")) {
        document.getElementById("alamat").value = organisasi.alamat || "";
      }
      if (document.getElementById("telepon")) {
        document.getElementById("telepon").value = organisasi.telepon || "";
      }
      if (document.getElementById("email")) {
        document.getElementById("email").value = organisasi.email || "";
      }
      if (document.getElementById("website")) {
        document.getElementById("website").value = organisasi.website || "";
      }
      if (document.getElementById("deskripsi")) {
        document.getElementById("deskripsi").value = organisasi.deskripsi || "";
      }

      // Load existing logo if available
      if (organisasi.logo && document.getElementById("logo")) {
        document.getElementById("logo").value = organisasi.logo;
        // Wait a bit to ensure all elements are ready
        setTimeout(() => {
          showLogoPreview(organisasi.logo, "Logo saat ini");
        }, 100);
      }
    }
  });

  // Also try immediately in case DOM is already ready (for faster loading)
  if (document.readyState === "loading") {
    // DOM is still loading, wait for DOMContentLoaded
  } else {
    // DOM is already ready
    if (typeof organisasi !== "undefined" && organisasi && organisasi.nama) {
      if (document.getElementById("nama")) {
        document.getElementById("nama").value = organisasi.nama || "";
      }
      if (document.getElementById("alamat")) {
        document.getElementById("alamat").value = organisasi.alamat || "";
      }
      if (document.getElementById("telepon")) {
        document.getElementById("telepon").value = organisasi.telepon || "";
      }
      if (document.getElementById("email")) {
        document.getElementById("email").value = organisasi.email || "";
      }
      if (document.getElementById("website")) {
        document.getElementById("website").value = organisasi.website || "";
      }
      if (document.getElementById("deskripsi")) {
        document.getElementById("deskripsi").value = organisasi.deskripsi || "";
      }

      // Load existing logo if available
      if (organisasi.logo && document.getElementById("logo")) {
        document.getElementById("logo").value = organisasi.logo;
        setTimeout(() => {
          showLogoPreview(organisasi.logo, "Logo saat ini");
        }, 100);
      }
    }
  }

  // File upload handling
  const logoFileInput = document.getElementById("logoFile");
  const logoUploadArea = document.getElementById("logoUploadArea");
  const logoUploadContent = document.getElementById("logoUploadContent");
  const logoPreview = document.getElementById("logoPreview");
  const logoPreviewImg = document.getElementById("logoPreviewImg");
  const logoFileName = document.getElementById("logoFileName");
  const logoProgress = document.getElementById("logoProgress");
  const logoProgressBar = document.getElementById("logoProgressBar");
  const logoProgressText = document.getElementById("logoProgressText");

  // Drag and drop
  logoUploadArea.addEventListener("dragover", (e) => {
    e.preventDefault();
    logoUploadArea.classList.add(
      "border-blue-500",
      "bg-blue-50",
      "dark:bg-blue-900/20"
    );
  });

  logoUploadArea.addEventListener("dragleave", (e) => {
    e.preventDefault();
    logoUploadArea.classList.remove(
      "border-blue-500",
      "bg-blue-50",
      "dark:bg-blue-900/20"
    );
  });

  logoUploadArea.addEventListener("drop", (e) => {
    e.preventDefault();
    logoUploadArea.classList.remove(
      "border-blue-500",
      "bg-blue-50",
      "dark:bg-blue-900/20"
    );

    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFileSelect(files[0]);
    }
  });

  logoFileInput.addEventListener("change", (e) => {
    if (e.target.files.length > 0) {
      handleFileSelect(e.target.files[0]);
    }
  });

  function handleFileSelect(file) {
    // Validate file type
    if (!file.type.startsWith("image/")) {
      Swal.fire({
        icon: "error",
        title: "File tidak valid",
        text: "Silakan pilih file gambar (PNG, JPG, GIF)",
      });
      return;
    }

    // Validate file size (2MB)
    if (file.size > 2 * 1024 * 1024) {
      Swal.fire({
        icon: "error",
        title: "File terlalu besar",
        text: "Ukuran file maksimal 2MB",
      });
      return;
    }

    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
      showLogoPreview(e.target.result, file.name);
    };
    reader.readAsDataURL(file);
  }

  // Function showLogoPreview sudah didefinisikan di atas

  function removeLogo() {
    logoFileInput.value = "";
    document.getElementById("logo").value = "";
    logoUploadContent.classList.remove("hidden");
    logoPreview.classList.add("hidden");
    logoPreviewImg.src = "";
    logoFileName.textContent = "";
  }

  // Form submission
  document
    .getElementById("organisasiForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const logoFile = logoFileInput.files[0];

      // If new file is selected, upload it first
      if (logoFile) {
        try {
          // Show progress
          logoProgress.classList.remove("hidden");
          logoProgressBar.style.width = "0%";
          logoProgressText.textContent = "0%";

          // Upload file
          const uploadFormData = new FormData();
          uploadFormData.append("logo", logoFile);

          const uploadResponse = await fetch("/organisasi/upload-logo", {
            method: "POST",
            body: uploadFormData,
          });

          const uploadResult = await uploadResponse.json();

          if (uploadResult.success) {
            // Update logo field with uploaded file path
            document.getElementById("logo").value = uploadResult.logoPath;
            logoProgressBar.style.width = "100%";
            logoProgressText.textContent = "100%";

            // Wait a bit then hide progress
            setTimeout(() => {
              logoProgress.classList.add("hidden");
            }, 500);
          } else {
            logoProgress.classList.add("hidden");
            Swal.fire({
              icon: "error",
              title: "Upload Gagal!",
              text: uploadResult.message || "Gagal mengupload logo",
            });
            return;
          }
        } catch (error) {
          logoProgress.classList.add("hidden");
          Swal.fire({
            icon: "error",
            title: "Error!",
            text: "Terjadi kesalahan saat upload: " + error.message,
          });
          return;
        }
      }

      // Submit form data
      const data = {
        nama: formData.get("nama"),
        alamat: formData.get("alamat"),
        telepon: formData.get("telepon"),
        email: formData.get("email"),
        logo: document.getElementById("logo").value || formData.get("logo"),
        website: formData.get("website"),
        deskripsi: formData.get("deskripsi"),
      };

      const response = await API.post("/organisasi/save", data);

      if (response.success) {
        Swal.fire({
          icon: "success",
          title: "Berhasil!",
          text: response.message,
          timer: 1500,
          showConfirmButton: false,
        }).then(() => {
          // Reload page untuk menampilkan data terbaru termasuk logo
          window.location.href = "/organisasi";
        });
      } else {
        Swal.fire({
          icon: "error",
          title: "Gagal!",
          text: response.message,
        });
      }
    });
</script>
